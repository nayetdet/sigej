{% extends "base.html" %}
{% block content %}
<h2>Itens de OS</h2>
<div class="hint">
  Precisa cadastrar algo antes? <a href="{{ url_for('os_bp.nova_os') }}">Abrir OS</a> ou
  <a href="{{ url_for('variacoes_bp.variacoes') }}">Cadastrar variação</a>.
</div>
<form method="post" class="card">
  <label>OS</label>
  <select name="os_id" required>
    <option value="">Selecione</option>
    {% for o in ordens %}
      <option value="{{ o.id }}" {% if o.id == os_id %}selected{% endif %}>{{ o.id }} — {{ o.numero_sequencial }}</option>
    {% endfor %}
  </select>
  <label>Variação de produto</label>
  <select name="produto_variacao_id" required>
    <option value="">Selecione</option>
    {% for v in variacoes %}
      <option value="{{ v.id }}">{{ v.id }} — Produto {{ v.produto_id }} — Cor {{ v.cor_id }} — Tam {{ v.tamanho_id }}</option>
    {% endfor %}
  </select>
  <label>Qtd. prevista</label>
  <input name="quantidade_prevista" type="number" step="0.01">
  <label>Qtd. usada</label>
  <input name="quantidade_usada" type="number" step="0.01">
  <button class="btn" type="submit">Adicionar item</button>
</form>

{% if os_id %}
  <h3>Itens da OS {{ os_id }}</h3>
  {% if itens %}
    <table>
      <tr><th>ID</th><th>Produto</th><th>Cor</th><th>Tamanho</th><th>Qtd prevista</th><th>Qtd usada</th></tr>
      {% for i in itens %}
        <tr>
          <td>{{ i.id }}</td>
          {% set v = variacoes_dict.get(i.produto_variacao_id) %}
          {% set prod = produtos.get(v.produto_id) if v else None %}
          <td>{{ v.produto_id if v else '' }} — {{ prod.descricao if prod else '' }}</td>
          <td>{{ v.cor_id if v else '' }}</td>
          <td>{{ v.tamanho_id if v else '' }}</td>
          <td>{{ i.quantidade_prevista }}</td>
          <td>{{ i.quantidade_usada }}</td>
        </tr>
      {% endfor %}
    </table>
  {% else %}
    <p>Nenhum item para esta OS.</p>
  {% endif %}
{% else %}
  <p>Selecione uma OS para ver itens.</p>
{% endif %}
{% endblock %}
